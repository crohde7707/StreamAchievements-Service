!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=17)}([function(e,t){e.exports=require("mongoose")},function(e,t,n){const o=n(0),i=new(0,o.Schema)({name:String,twitchID:String,logo:String,email:String,type:String,broadcaster_type:String,channels:[{channelID:String,achievements:[{aid:Number,earned:Date}],sync:Boolean}],favorites:Array,delegate:Array,integration:{twitch:Object,patreon:Object},preferences:{autojoin:Boolean},lastLogin:Date}),a=o.model("user",i);e.exports=a},function(e,t,n){const o=n(0),i=new(0,o.Schema)({owner:String,twitchID:String,theme:String,logo:String,members:Array,moderators:[{uid:String,permissions:{channel:Boolean,chat:Boolean}}],icons:{default:String,hidden:String},oid:String,overlay:{chat:Boolean,chatMessage:String,sfx:String,enterEffect:String,exitEffect:String,duration:Number,volume:Number,delay:Number},gold:Boolean,nextUID:Number,broadcaster_type:{twitch:String,mixer:String,youtube:String}}),a=o.model("channel",i);e.exports=a},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("cryptr")},function(e,t){e.exports=require("passport")},function(e,t,n){const o=n(0),i=new(0,o.Schema)({user:String,logo:String,message:String,date:Date,type:String,channel:String,status:String}),a=o.model("notice",i);e.exports=a},function(e,t,n){const o=n(1),i=n(2),a=new(n(4))(process.env.SCK),s=n(30);e.exports={authCheck:(e,t,n)=>{e.user?n():t.redirect("/auth/twitch")},isAuthorized:async(e,t,n)=>{if(e.cookies.etid)try{let i=a.decrypt(e.cookies.etid),s=await o.findOne({"integration.twitch.etid":i});s?(e.user=s,t.cookie("etid",e.cookies.etid,{maxAge:288e5,secure:!0,httpOnly:!1,domain:"streamachievements.com"}),n()):(t.clearCookie("etid"),t.status(401),t.json({}))}catch(e){t.clearCookie("etid"),t.status(401),t.json({})}else s(e,t),t.status(401),t.json({foo:"bar"})},isModAuthorized:async(e,t,n)=>{if(e.cookies.etid&&e.query.channel){let s=a.decrypt(e.cookies.etid),r=await o.findOne({"integration.twitch.etid":s});if(r){e.user=r;let o=await i.findOne({owner:e.query.channel,"moderators.uid":e.user._id});o?(e.channel=o,n()):(t.status(401),t.redirect(process.env.WEB_DOMAIN+"/mod"))}else t.clearCookie("etid"),t.status(401),t.redirect(process.env.WEB_DOMAIN)}else t.status(401),t.redirect(process.env.WEB_DOMAIN)},isAdminAuthorized:async(e,t,n)=>{let i=a.decrypt(e.cookies.etid),s=await o.findOne({"integration.twitch.etid":i});s&&(s.type="admin")?(e.user=s,t.cookie("etid",e.cookies.etid,{maxAge:144e5,secure:!0,httpOnly:!1,domain:"streamachievements.com"}),n()):(t.status(401),t.json({message:"You are not authorized to make this request."}),n())}}},function(e,t){e.exports={emitNewChannel:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("new-channel",{name:t.name,"full-access":t["full-access"],connected:!1})},emitNewListener:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("new-listener",t)},emitUpdateListener:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("update-listener",t)},emitRemoveListener:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("remove-listener",t)},emitBecomeGold:(e,t)=>{console.log(t+" is becoming gold");let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("become-gold",t)},emitRemoveGold:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("remove-gold",t)},emitAwardedAchievement:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("achievement-awarded",t)},emitAwardedAchievementNonMember:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("achievement-awarded-nonMember",t)},emitTestListener:(e,t)=>{let n=e.app.get("ws"),o=e.app.get("IRCSOCKET");n.to(o).emit("test",t)},emitOverlayAlert:(e,t)=>{let n=e.app.get("ws"),o=e.app.get(t.channel+"-OVERLAYS");o&&o.forEach(e=>{n.to(e).emit("alert-recieved",t)})},emitOverlaySettingsUpdate:(e,t)=>{let n=e.app.get("ws"),o=e.app.get(t.channel+"-OVERLAYS");o&&o.forEach(e=>{n.to(e).emit("update-settings",t.overlay)})},emitNotificationsUpdate:(e,t)=>{let n=e.app.get("ws"),o=e.app.get(t.user+"-NOTIFICATIONS");o&&o.forEach(e=>{n.to(e).emit("notification-received",t)})}}},function(e,t,n){const o=n(0),i=new(0,o.Schema)({uid:Number,channel:String,title:String,description:String,icon:String,earnable:Boolean,limited:Boolean,secret:Boolean,listener:String,first:String,earned:Date,alert:Boolean,order:Number}),a=o.model("achievement",i);e.exports=a},function(e,t,n){const o=n(0);var i=new(0,o.Schema)({uid:String,token:String,created:Date});i.methods.hasExpired=function(){return Date.now()-Date.parse(this.created)>2592e5};const a=o.model("token",i);e.exports=a},function(e,t,n){const o=n(0),i=o.Schema,a=new i({uid:String,channel:String,achType:String,resubType:String,bot:String,query:i.Types.Mixed,condition:String,achievement:String,aid:Number}),s=o.model("listener",a);e.exports=s},function(e,t){e.exports=require("axios")},function(e,t,n){const o=n(0),i=new(0,o.Schema)({name:String,type:String,channel:String,cloudID:String,url:String,achievementID:String}),a=o.model("image",i);e.exports=a},function(e,t,n){const o=n(0),i=new(0,o.Schema)({twitchID:String,name:String,channelID:String,achievementID:Number,earned:Date}),a=o.model("queue",i);e.exports=a},function(e,t){e.exports=require("uuid/v1")},function(e,t,n){const o=n(13);let i=n(38).v2;i.config({cloud_name:process.env.CLDNAME,api_key:process.env.CLDKEY,api_secret:process.env.CLDS});e.exports={uploadImage:(e,t,n,a)=>{return new Promise((s,r)=>{o.findOne({name:t,channel:n}).then(l=>{l?(console.log("\nimage already exists"),s(l)):(console.log("\nnew image"),i.uploader.upload(e,(e,i)=>{e?(console.log(e),r({error:e})):(console.log("\nimage uploaded successfully"),new o({name:t,channel:n,cloudID:i.public_id,url:i.url,type:a||"achievement"}).save().then(e=>{console.log("new image in DB"),s(e)}))}))})})},destroyImage:e=>new Promise((t,n)=>{i.uploader.destroy(e,function(e){t(e)})})}},function(e,t,n){e.exports=n(18)},function(e,t,n){(function(e){const t=n(3),o=n(19),i=n(0),a=(n(20),n(5)),s=(n(21),n(22),n(24)),r=n(25),l=n(26).allowAccess,{searchChannels:d,searchMembers:c,searchMembersDetailed:h,searchMod:u,storeSocket:m,removeSocket:p,markNotificationRead:g,deleteNotification:f}=n(27);let v=n(28),y=n(29),w=n(33);const b=process.env.PORT||5e3;let _=t();_.set("view engine","ejs"),_.use(s()),_.use(r({limit:"50mb",extended:!0})),i.connect(process.env.MDB,{useNewUrlParser:!0},()=>{console.log("connected to mongodb")}),_.use(a.initialize()),_.use(a.session()),_.use(t.static("public")),_.use("/auth",[l],y),_.use("/api",[l],w),_.use(t.static(o.join(e,"client/build")));let I;_.listen(b);I=v.listen(process.env.SOCKET_PORT),_.set("ws",I),I.on("connection",function(e){e.handshake&&e.handshake.query&&m(e,_),e.on("handshake",function(t){if(t.name="SAIRC")_.set("IRCSOCKET",e.id);else if(t.web){let n=_.get("USERSOCKETS");n?n[t.user]=e.id:((n={})[t.user]=e.id,_.set("USERSOCKETS",n))}}),e.on("search-directory",t=>{d(e,t)}),e.on("search-members",t=>{h(e,t)}),e.on("search-gift-member",t=>{c(e,t)}),e.on("search-mod",t=>{u(e,t)}),e.on("mark-notification-read",t=>{g(e,t)}),e.on("delete-notification",t=>{f(e,t)}),e.on("disconnect",()=>{p(e,_)})}),console.log(`Express app listening on port ${b}`)}).call(this,"/")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("cookie-session")},function(e,t,n){const o=n(0),i=new(0,o.Schema)({socketID:String,name:String}),a=o.model("socket",i);e.exports=a},function(e,t,n){const o=n(5),i=n(23).Strategy,a=n(1),s=n(2),r=n(6),l=new(n(4))(process.env.SCK);o.serializeUser((e,t)=>{t(null,e)}),o.use(new i({clientID:process.env.TCID,clientSecret:process.env.TCS,callbackURL:process.env.TPR},(e,t,n,o)=>{let i=l.encrypt(e),d=l.encrypt(t),c={etid:n.id.toString(),token:i,refresh:d};a.findOne({"integration.twitch.etid":c.etid}).then(e=>{let t=!1;e?(e.integration.twitch=c,e.name!==n.login&&(e.name=n.login,t=!0),e.logo!==n.profile_image_url&&(e.logo=n.profile_image_url,t=!0),e.email!==n.email&&(e.email=n.email,t=!0),e.broadcaster_type!==n.broadcaster_type&&(e.broadcaster_type=n.broadcaster_type,t=!0),e.save().then(e=>{s.findOne({twitchID:e.integration.twitch.etid}).then(n=>{n?(n.owner!==e.name&&(t=!0,n.owner=e.name),n.logo!==e.logo&&(t=!0,n.logo=e.logo),n.save().then(n=>{t&&new r({user:e._id,logo:"https://res.cloudinary.com/phirehero/image/upload/v1558811694/default-icon.png",message:"We noticed some information has been updated on Twitch, so we went ahead and updated your profile with those changes!",date:Date.now(),type:"profile",status:"new"}).save(),o(null,e)})):(t&&new r({user:e._id,logo:"https://res.cloudinary.com/phirehero/image/upload/v1558811694/default-icon.png",message:"We noticed some information has been updated on Twitch, so we went ahead and updated your profile with those changes!",date:Date.now(),type:"profile",status:"new"}).save(),o(null,e))})})):new a({name:n.login,logo:n.profile_image_url,email:n.email,type:"user",channels:[],integration:{twitch:c},preferences:{autojoin:!0}}).save().then(e=>{o(null,e)})})}))},function(e,t){e.exports=require("passport-twitch.js")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t,n){e.exports={allowAccess:async(e,t,n)=>{var o;o=["http://www.streamachievements.com","http://streamachievements.com","https://www.streamachievements.com","https://streamachievements.com"];var i=e.headers.origin;o.indexOf(i)>-1&&t.setHeader("Access-Control-Allow-Origin",i),t.header("Access-Control-Allow-Credentials",!0),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n()}}},function(e,t,n){const o=n(2),i=n(1),a=n(6),s=new(n(4))(process.env.SCK);e.exports={searchChannels:(e,t)=>{let n=new RegExp(t,"gi");o.find({owner:n}).sort({_id:-1}).limit(25).exec((t,n)=>{let o=n.map(e=>({owner:e.owner,logo:e.logo}));e.emit("channel-results",o)})},searchMembers:(e,t)=>{let n=new RegExp(t.value,"gi");o.findOne({owner:t.owner}).then(o=>{o&&i.find({_id:{$in:o.members},name:n}).sort({_id:-1}).limit(25).exec((n,i)=>{let a=i.map(e=>{let n=e.channels.findIndex(e=>e.channelID===o.id),i=e.channels[n].achievements.findIndex(e=>e.aid===t.aid);return{name:e.name,logo:e.logo,earned:i>=0}});e.emit("members-retrieved",a)})})},searchMembersDetailed:(e,t)=>{let n=new RegExp(t.value,"gi");o.findOne({owner:t.owner}).then(t=>{t&&i.find({_id:{$in:t.members},name:n}).sort({_id:-1}).limit(25).exec((n,o)=>{let i=o.map(e=>{let n=e.channels.findIndex(e=>e.channelID===t.id),o=e.channels[n].achievements.map(e=>e.aid);return{name:e.name,logo:e.logo,achievements:o}});console.log(i),e.emit("member-results",i)})})},searchMod:(e,t)=>{let n=new RegExp(t.value,"gi");o.findOne({owner:t.owner}).then(t=>{t&&i.find({_id:{$in:t.members},name:n}).sort({_id:-1}).limit(25).exec((n,o)=>{let i=o.map(e=>{let n=t.moderators.findIndex(t=>t.uid===e.id);return{name:e.name,logo:e.logo,isMod:n>=0}});e.emit("members-retrieved",i)})})},storeSocket:(e,t)=>{if(e.handshake.query.uid)o.findOne({oid:e.handshake.query.uid}).then(n=>{if(n){let o=t.get(n.owner+"-OVERLAYS"),i=t.get("SOCKET-LOOKUP");i||(i={}),o?o.push(e.id):o=[e.id],console.log(n.owner+"'s sockets: "+o.join(",")),t.set(n.owner+"-OVERLAYS",o),i[e.id]={name:n.owner,type:"OVERLAYS"},t.set("SOCKET-LOOKUP",i)}else e.emit("connect-issue","Issue while connecting")});else if(e.handshake.query.nid){let n=s.decrypt(e.handshake.query.nid);i.findById(n).then(n=>{let o=t.get(n.name+"-NOTIFICATIONS"),i=t.get("SOCKET-LOOKUP");i||(i={}),o?o.push(e.id):o=[e.id],t.set(n.name+"-NOTIFICATIONS",o),i[e.id]={name:n.name,type:"NOTIFICATIONS"},t.set("SOCKET-LOOKUP",i)})}},removeSocket:(e,t)=>{let n=t.get("SOCKET-LOOKUP");if(n){let o=n[e.id];if(o){let i=t.get(`${o.name}-${o.type}`);if(i){let n=i.filter(t=>t!==e.id);t.set(`${o.name}-${o.type}`,n)}delete n[e.id],t.set("SOCKET-LOOKUP",n)}}},markNotificationRead:(e,t)=>{if(t.notification)a.findById(t.notification.id).then(t=>{t.status="read",t.save().then(t=>{e.emit("notification-read",t.id)})});else if(t.nid){let n=s.decrypt(t.nid);a.find({user:n}).then(t=>{t&&(t.forEach(e=>{"read"!==e.status&&(e.status="read",e.save())}),e.emit("notification-read","all"))})}},deleteNotification:(e,t)=>{a.findByIdAndRemove(t.id).then(t=>{e.emit("notification-removed",t.id)})}}},function(e,t){e.exports=require("socket.io")},function(e,t,n){const o=n(3).Router(),i=n(5),a=n(4),s=n(12),r=new a(process.env.SCK),l=n(7).isAuthorized,d=(n(1),n(2)),{emitBecomeGold:c,emitRemoveGold:h}=n(8);n(31);let u=n(32),m=u.patreon,p=(0,u.oauth)(process.env.PCID,process.env.PCS);const g="https://www.patreon.com/api/oauth2/v2/identity?include=memberships&fields%5Buser%5D=thumb_url,vanity";o.get("/twitch",i.authenticate("twitch.js",{scope:["user_read","user:read:email"]})),o.get("/twitch/redirect",i.authenticate("twitch.js"),(e,t)=>{console.log(e.cookies),e.session.user=e.user;let n=r.encrypt(e.user.integration.twitch.etid);t.cookie("etid",n,{maxAge:144e5,httpOnly:!1,secure:!0,domain:"streamachievements.com"}),new Promise((t,n)=>{"user"!==e.user.type?d.findOne({owner:e.user.name}).then(n=>{n?n.broadcaster_type?n.broadcaster_type.twitch!==e.user.broadcaster_type?(n.broadcaster_type.twitch=e.user.broadcaster_type,n.save().then(e=>{t()})):t():(n.broadcaster_type={twitch:e.user.broadcaster_type},n.save().then(e=>{t()})):t()}):t()}).then(()=>{let n=e.user.integration.patreon;if(n&&"lifetime"!==n.status){let o,{at:i,rt:a,id:l,expires:u}=n;v(u)?(console.log("patreon token expired"),o=new Promise((t,o)=>{y(e,n.rt).then(e=>{console.log("token is refreshed"),e&&(i=e.at,a=e.rt,u=e.expires),t()})})):o=Promise.resolve(),o.then(()=>{let o=r.decrypt(i);l?(console.log("getting up to date info from patreon"),s.get(`https://www.patreon.com/api/oauth2/v2/members/${l}?include=currently_entitled_tiers&fields%5Bmember%5D=patron_status,full_name,is_follower,last_charge_date&fields%5Btier%5D=amount_cents,description,discord_role_ids,patron_count,published,published_at,created_at,edited_at,title,unpublished_at`,{headers:{Authorization:`Bearer ${o}`}}).then(o=>{console.log("up to date info obtained");let s=o.data.data.attributes.patron_status,r=o.data.data.attributes.is_follower,l=o.data.data.relationships.currently_entitled_tiers.data.map(e=>e.id).indexOf("3497710")>=0,m={id:n.id,thumb_url:n.thumb_url,vanity:n.vanity,at:i,rt:a,is_follower:r,status:s,is_gold:l,expires:u};e.user.integration.patreon?!e.user.integration.patreon.is_gold&&l?c(e,e.user.name):e.user.integration.patreon.is_gold&&!l&&h(e,e.user.name):l?c(e,e.user.name):h(e,e.user.name);let p=Object.assign({},e.user.integration);p.patreon={...m},e.user.integration=p,e.user.lastLogin=Date.now(),e.user.save().then(n=>{"verified"!==n.type&&"admin"!==n.type||d.findOne({owner:e.user.name}).then(e=>{e.gold!==n.integration.patreon.is_gold&&(e.gold=n.integration.patreon.is_gold,e.save())}),f(e,t)})}).catch(n=>{if(console.log(n.response),401===n.response.status||403===n.response.status)t.redirect("/auth/patreon");else if(404===n.response.status){let n=Object.assign({},e.user.integration),o={id:null,thumb_url:n.patreon.thumb_url,vanity:n.patreon.vanity,at:n.patreon.at,rt:n.patreon.rt,is_follower:null,status:null,is_gold:null,expires:n.patreon.expires};n.patreon={...o},e.user.integration=n,e.user.lastLogin=Date.now(),e.user.save().then(n=>{"verified"!==n.type&&"admin"!==n.type||d.findOne({owner:e.user.name}).then(e=>{e.gold!==n.integration.patreon.is_gold&&(e.gold=!1,e.save())}),f(e,t)})}})):(console.log("grabbing id from user"),(l=e.user.integration.patreon.id)||(e.user.lastLogin=Date.now(),e.user.save().then(n=>{f(e,t)})))})}else e.user.lastLogin=Date.now(),e.user.save().then(n=>{f(e,t)})})}),o.get("/patreon",l,(e,t)=>{console.log("why tho?");let n="https://www.patreon.com/oauth2/authorize?";n+="response_type=code&",n+="client_id="+process.env.PCID+"&",n+="redirect_uri="+process.env.PPR,n+="&scope=campaigns%20identity%20identity%5Bemail%5D%20campaigns.members",t.redirect(n)}),o.get("/patreon/redirect",l,(e,t)=>{let n=e.query.code;return p.getTokens(n,process.env.PPR).then(t=>{m(t.access_token);let n=e.cookies.etid;return new Promise((e,o)=>{let i,a,l=r.encrypt(t.access_token),d=r.encrypt(t.refresh_token),c=new Date,h=(new Date).setDate(c.getDate()+14);s.get(g,{headers:{Authorization:`Bearer ${t.access_token}`}}).then(o=>{if(i=o.data.data.attributes.vanity,a=o.data.data.attributes.thumb_url,o.data.included){let r=o.data.included[0].id;s.get(`https://www.patreon.com/api/oauth2/v2/members/${r}?include=currently_entitled_tiers&fields%5Bmember%5D=patron_status,full_name,is_follower,last_charge_date&fields%5Btier%5D=amount_cents,description,discord_role_ids,patron_count,published,published_at,created_at,edited_at,title,unpublished_at`,{headers:{Authorization:`Bearer ${t.access_token}`}}).then(t=>{let o=t.data.data.attributes.patron_status,s=t.data.data.attributes.is_follower,c=t.data.data.relationships.currently_entitled_tiers.data.map(e=>e.id).indexOf("3497710")>=0;e({id:r,thumb_url:a,vanity:i,at:l,rt:d,etid:n,is_follower:s,status:o,is_gold:c,expires:h})})}else e({thumb_url:a,vanity:i,at:l,rt:d,etid:n,expires:h})})})}).then(n=>{let{id:o,thumb_url:i,vanity:a,at:s,rt:r,etid:l,is_follower:u,status:m,is_gold:p,expires:g}=n,f=Object.assign({},e.user.integration);f.patreon={id:o,thumb_url:i,vanity:a,at:s,rt:r,is_follower:u,status:m,is_gold:p,expires:g},p?c(e,e.user.name):h(e,e.user.name),e.user.integration=f,e.user.save().then(n=>{"verified"===n.type&&d.findOne({owner:e.user.name}).then(e=>{e.gold!==p&&(e.gold=p,e.save())}),t.redirect(process.env.WEB_DOMAIN+"profile")})})}),o.post("/twitch/sync",l,(e,t)=>{w(e.user,e.cookies.etid).then(e=>{t.json(e)})}),o.post("/patreon/sync",l,(e,t)=>{b(e,e.cookies.etid).then(e=>{t.json(e)})}),o.post("/patreon/unlink",l,(e,t)=>{let n=Object.assign({},e.user.integration);delete n.patreon,"verified"===e.user.type&&h(e,e.user.name),e.user.integration=n,e.user.save().then(n=>{d.findOne({owner:e.user.name}).then(e=>{e?(e.icons={default:"https://res.cloudinary.com/phirehero/image/upload/v1558811694/default-icon.png",hidden:"https://res.cloudinary.com/phirehero/image/upload/v1558811887/hidden-icon.png"},e.save().then(e=>{t.json({success:!0,service:"patreon"})})):t.json({success:!0,service:"patreon"})})})});let f=(e,t)=>{let n=e.cookies._ru;if(n){let e=r.decrypt(n);t.clearCookie("_ru",{domain:"streamachievements.com"}),e?0!=e.indexOf(process.env.WEB_DOMAIN)?t.redirect(process.env.WEB_DOMAIN+"home"):t.redirect(e):t.redirect(process.env.WEB_DOMAIN+"home")}else t.redirect(process.env.WEB_DOMAIN+"home")},v=e=>{let t=new Date(e);return new Date>t},y=(e,t)=>new Promise((n,o)=>{let i=r.decrypt(t);console.log("calling to get a token refresh"),s.post(`https://www.patreon.com/api/oauth2/token?grant_type=refresh_token&refresh_token=${i}&client_id=${process.env.PCID}&client_secret=${process.env.PCS}`).then(t=>{console.log("token obtained");let o=r.encrypt(t.data.access_token),i=r.encrypt(t.data.refresh_token),a=new Date,s=(new Date).setDate(a.getDate()+14),l=Object.assign({},e.user.integration);l.patreon.at=o,l.patreon.rt=i,l.patreon.expires=s,e.user.integration=l,e.user.save().then(e=>{n({at:o,rt:i,expires:s})})}).catch(e=>{n(null)})}),w=(e,t)=>e.integration.twitch?new Promise((t,n)=>{s.get(`https://api.twitch.tv/helix/users/?id=${e.integration.twitch.etid}`,{headers:{"Client-ID":process.env.TCID}}).then(n=>{e.name=n.data.data[0].login,e.logo=n.data.data[0].profile_image_url,e.save().then(e=>{d.findOne({twitchID:e.integration.twitch.etid}).then(n=>{n?(n.owner!==e.name&&(updated=!0,n.owner=e.name),n.logo!==e.logo&&(updated=!0,n.logo=e.logo),n.save().then(n=>{t({username:e.name,logo:e.logo})})):t({username:e.name,logo:e.logo})})})})}):Promise.resolve(),b=(e,t)=>e.user.integration.patreon?new Promise((n,o)=>{let i,{at:a,rt:l,id:u,expires:m}=e.user.integration.patreon;(i=v(m)?new Promise((t,n)=>{y(e.user,l).then(e=>{e&&(a=e.at,l=e.rt,m=e.expires),t()})}):Promise.resolve()).then(()=>{let o=r.decrypt(a);s.get(g,{headers:{Authorization:`Bearer ${o}`}}).then(i=>{if(vanity=i.data.data.attributes.vanity,thumb_url=i.data.data.attributes.thumb_url,i.data.included){let r=i.data.included[0].id;s.get(`https://www.patreon.com/api/oauth2/v2/members/${r}?include=currently_entitled_tiers&fields%5Bmember%5D=patron_status,full_name,is_follower,last_charge_date&fields%5Btier%5D=amount_cents,description,discord_role_ids,patron_count,published,published_at,created_at,edited_at,title,unpublished_at`,{headers:{Authorization:`Bearer ${o}`}}).then(o=>{let i=o.data.data.attributes.patron_status,s=o.data.data.attributes.is_follower,u=o.data.data.relationships.currently_entitled_tiers.data.map(e=>e.id).indexOf("3497710")>=0,p={id:r,thumb_url:thumb_url,vanity:vanity,at:a,rt:l,etid:t,is_follower:s,status:i,is_gold:u,expires:m};!e.user.integration.patreon.is_gold&&u?c(e,e.user.name):e.user.integration.patreon.is_gold&&!u&&h(e,e.user.name);let g=Object.assign({},e.user.integration);g.patreon={...p},e.user.integration=g,e.user.save().then(e=>{"verified"===e.type&&d.findOne({owner:e.name}).then(t=>{t.gold!==e.integration.patreon.is_gold&&(t.gold=e.integration.patreon.is_gold,t.save())}),n({vanity:e.integration.patreon.vanity,thumb_url:e.integration.patreon.thumb_url,follower:e.integration.patreon.is_follower,status:e.integration.patreon.status,gold:e.integration.patreon.is_gold})})})}else n({thumb_url:thumb_url,vanity:vanity,at:a,rt:l,etid:t})})})}):Promise.resolve();o.get("/logout",(e,t)=>{e.logout(),t.clearCookie("etid",{domain:"streamachievements.com"}),t.redirect(process.env.WEB_DOMAIN)}),e.exports=o},function(e,t,n){const o=new(n(4))(process.env.SCK),i={"/api/profile":"profile","/api/achievement/retrieve":"dashboard","/api/channel/dashboard":"dashboard","/api/channel/retrieve":"channel/{channel}","/api/channel/mod":"mod","/api/channel/mod/retrieve":"mod/{channel}","/api/achievement/mod/retrieve":"mod/{channel}"};e.exports=(e,t)=>{let{originalUrl:n,params:a,query:s,headers:r}=e,l=process.env.WEB_DOMAIN;if(r.origin+"/"===process.env.WEB_DOMAIN){let e=n.split("?")[0];console.log(e),e&&(l+=i[e],console.log(l),l=s&&s.channel?l.replace(new RegExp("{channel}","gi"),s.channel):l.replace(new RegExp("/{channel}","gi"),""),t.cookie("_ru",o.encrypt(l),{maxAge:144e5,secure:!0,httpOnly:!1,domain:"streamachievements.com"}))}}},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("patreon")},function(e,t,n){const o=n(3).Router(),i=n(5),a=n(1),s=n(2),r=n(6),l=n(9),d=n(10),c=n(0),h=new(n(4))(process.env.SCK);let u=n(34),m=n(40),p=n(42),g=n(43);const{isAuthorized:f,isAdminAuthorized:v}=n(7),{emitTestListener:y,emitNewChannel:w}=n(8);o.use("/channel",u),o.use("/achievement",m),o.use("/irc",p),o.use("/admin",g),o.get("/token",i.authenticate("twitch"),(e,t)=>t.json({success:!0,data:e.user.id}));let b=!1;o.get("/users",v,(e,t)=>{d.find({}).then(e=>{let n={},o=e.map(e=>(n[e.uid]=e.token,e.uid));a.find({_id:{$in:o}}).then(e=>{let o=e.map(e=>({name:e.name,logo:e.logo,status:"not issued"===n[e.id]?"new":"pending"}));t.json({users:o})})})}),o.get("/user",f,(e,t)=>{let n,o=h.encrypt(e.user._id),i=!1;if(setTimeout(()=>{b&&(console.log("timeout"),t.status(500),t.json({message:"Internal Server Issue"}))},1e4),e.user.integration.patreon){let t=e.user.integration.patreon;n={vanity:t.vanity,thumb_url:t.thumb_url,follower:t.is_follower,status:t.status,gold:t.is_gold}}else n=!1;r.countDocuments({user:e.user._id,status:"new"}).exec().then(a=>{s.findOne({twitchID:e.user.integration.twitch.etid}).then(r=>{s.find({"moderators.uid":e.user._id}).then(s=>{if(s&&(i=!0),b=!1,r)t.json({username:e.user.name,logo:e.user.logo,patreon:n,status:"verified",type:e.user.type,preferences:e.user.preferences,notificationCount:a,uid:o,isMod:i});else{let s="viewer";d.findOne({uid:e.user._id}).then(r=>{r&&(s="not issued"===r.token?"review":"pending"),t.json({username:e.user.name,logo:e.user.logo,patreon:n,status:s,type:e.user.type,preferences:e.user.preferences,notificationCount:a,uid:o,isMod:i})})}})})})}),o.get("/profile",f,(e,t)=>{let n=e.user.channels.map(e=>new c.Types.ObjectId(e.channelID));s.find({_id:{$in:n}}).then(n=>{let o=n.map(t=>{let n=e.user.channels.filter(e=>e.channelID===t.id),o=0;return new Promise((e,i)=>{l.countDocuments({channel:t.owner}).then(i=>{i>0&&(o=Math.round(n[0].achievements.length/i*100)),e({logo:t.logo,owner:t.owner,percentage:o})})})}),i=new Promise((t,n)=>{r.countDocuments({user:e.user._id}).exec().then(n=>{r.find({user:e.user._id}).sort({date:-1}).limit(15).exec((e,n)=>{if(n){let e=!1,o=n.map(e=>({id:e._id,logo:e.logo,message:e.message,date:e.date,type:e.type,channel:e.channel,status:e.status}));15===o.length&&(e=15),t({notifications:o,next:e})}else t([])})})});Promise.all(o).then(n=>{i.then(o=>{e.user.preferences?t.json({channels:n,preferences:e.user.preferences,notifications:o.notifications,next:o.next}):(e.user.preferences={autojoin:!1},e.user.save().then(e=>{t.json({channels:n,preferences:e.preferences,notifications:o.notifications,next:o.next})}))})})})}),o.get("/notifications",f,(e,t)=>{let n=parseInt(e.query.next);r.find({user:e.user._id}).sort({date:-1}).skip(n).limit(15).exec((e,n)=>{if(n){let e=!1,o=n.map(e=>({id:e._id,logo:e.logo,message:e.message,date:e.date,type:e.type,channel:e.channel,status:e.status}));15===o.length&&(e+=15),t.json({notifications:o,next:e})}else t.json([])})}),o.post("/profile/preferences",f,(e,t)=>{let n={...e.user.preferences}||{};n={...e.body.preferences},e.user.preferences=n,e.user.save().then(n=>{t.json(e.user.preferences)})}),o.post("/test",v,(e,t)=>{w(e,{name:e.body.channel,"full-access":!1})}),e.exports=o},function(e,t,n){const o=n(3).Router(),i=(n(5),n(15)),{isAuthorized:a,isModAuthorized:s,isAdminAuthorized:r}=n(7),l=n(0),d=(new(n(4))(process.env.SCK),n(35)),c=n(36),h=n(37),u=n(1),m=n(2),p=n(9),g=n(11),f=n(13),v=n(10),y=n(14),w=n(6),{uploadImage:b,destroyImage:_}=n(16),{emitNewChannel:I,emitOverlaySettingsUpdate:x,emitOverlayAlert:D}=n(8),O="https://res.cloudinary.com/phirehero/image/upload/v1558811694/default-icon.png",j="https://res.cloudinary.com/phirehero/image/upload/v1558811887/hidden-icon.png",S=/^https:\/\/res\.cloudinary\.com\/phirehero\/.*\.(png|jpg|jpeg)$/gm,T=n(39);o.get("/create",a,(e,t)=>{m.findOne({twitchID:e.user.twitchID}).then(n=>{n?t.json({error:"Channel already exists!",channel:n}):new m({owner:e.user.name,twitchID:e.user.twitchID,theme:"",logo:e.user.logo,achievements:[],members:[],icons:{default:O,hidden:j},oid:i(),nextUID:1}).save().then(n=>{let o=!1;e.user.integration&&e.user.integration.patreon&&("forever"===e.user.integration.patreon.type||e.user.integration.patreon.is_gold)&&(o=!0),I({name:e.user.name,"full-access":o,online:!1}),e.user.channelID=n.id,e.user.save().then(o=>{t.json({channel:n,user:e.user})})})})}),o.post("/leave",a,(e,t)=>{m.findOne({owner:e.body.channel}).then(n=>{if(n){let o,i=n.members;i.length>0&&i.includes(e.user.id)?(o=i.findIndex(t=>{e.user.id}),i.splice(o,1),n.save().then(n=>{o=0,o=e.user.channels.findIndex(e=>e.channelID===n.id),e.user.channels.splice(o,1),e.user.save().then(e=>{t.json({leave:!0})})})):t.send("User isn't a part of this channel")}else t.send("Channel doesn't exist")})}),o.post("/join",a,(e,t)=>{m.findOne({owner:e.body.channel}).then(n=>{if(n){let o=e.user.channels.some(e=>e.channelID===n.id),i=n.members.includes(e.user.id);if(o)i?t.json({user:e.user,channel:n}):(n.members.push(e.user.id),n.save().then(n=>{t.json({user:e.user,channel:n})}));else if(i)o?t.json({user:e.user,channel:n}):(e.user.channels.push({channelID:n.id,achievements:[],sync:!0}),e.user.save().then(e=>{t.json({user:e,channel:n})}));else{let o={channelID:n.id,achievements:[],sync:!0};console.log("checking queues..."),y.find({twitchID:e.user.integration.twitch.etid,channelID:n.id}).then(i=>{i&&(console.log("Giving achievements to "+e.user.name),i.forEach(e=>{console.log("awarding "+e.achievementID),o.achievements.push({aid:e.achievementID,earned:e.earned||new Date}),y.deleteOne({_id:e.id}).then(e=>{console.log(e)})}),console.log("---------------")),e.user.channels.push(o),e.user.save().then(e=>{n.members.push(e.id),n.save().then(n=>{t.json({user:e,channel:n})})})})}}else t.status(405),t.send("Channel requested to join does not exist!")})}),o.get("/list",(e,t)=>{m.find({},(e,n)=>{t.json(n)})}),o.get("/retrieve",a,(e,t)=>{let n=e.query.channel;if(e.query.bb&&m.find({watcher:!0}).then(e=>{e.map(e=>({name:e.owner,listeners:e.listeners}))}),n){let o=!1;m.findOne({owner:n}).then(i=>{if(i){if(e.user.favorites){e.user.favorites.findIndex(e=>e===i.id)>=0&&(o=!0)}p.find({channel:n}).then(a=>{let s,r,l=i.members.includes(e.user.id);if(l){let t=e.user.channels.findIndex(e=>e.channelID===i.id),n=e.user.channels[t].achievements,o={},l=n.filter((e,t)=>{return a.findIndex(t=>t.uid===e.aid)>=0&&!o[e.aid]&&(o[e.aid]=!0,!0)});l.length!==n.length&&(e.user.channels[t].achievements=l,e.user.save(),console.log("synced achievements..."),n=l),s=n.map(e=>e.aid),r=a.map(e=>{let t=Object.assign({},e._doc),o=s.findIndex(e=>e===t.uid);return o>=0&&(t.earned=n[o].earned),t})}else r=a;let d=r.map(e=>{let t=e._doc?{...e._doc}:e;return delete t.__v,delete t._id,t});d.sort((e,t)=>e.order>t.order?1:-1),u.findOne({name:n}).then(e=>{if(e){let n=!1;e.integration.patreon&&e.integration.patreon.is_gold&&(n=!0);let a={...i._doc};delete a.__v,delete a._id,t.json({channel:a,achievements:d,joined:l,fullAccess:n,favorited:o})}else t.json({error:"Channel doesn't exist"})})})}else t.json({error:"No channel found for the name: "+n})})}}),o.get("/dashboard",a,(e,t)=>{m.findOne({twitchID:e.user.integration.twitch.etid}).then(e=>{if(e){let n=new Promise((t,n)=>{p.find({channel:e.owner}).then(e=>{if(e){let n=e.map(e=>e.listener);g.find({_id:{$in:n}}).then(n=>{let o=e.map(e=>{let t=n.find(t=>t.id===e.listener);if(t){let n={_id:e._id,uid:e.uid,channel:e.owner,title:e.title,description:e.description,icon:e.icon,earnable:e.earnable,limited:e.limited,secret:e.secret,listener:e.listener,code:t.code,order:e.order};return t.resubType&&(n.resubType=t.resubType),t.query&&(n.query=t.query),n}return e});o.sort((e,t)=>e.order>t.order?1:-1),t(o)})}else t(e)})}),o=new Promise((t,n)=>{f.find({channel:e.owner}).then(e=>{t(e?{gallery:e}:{gallery:[]})})}),a=new Promise((t,n)=>{let o=e.moderators.map(e=>e.uid);u.find({_id:{$in:o}}).then(n=>{let o=n.map(t=>{let n=e.moderators.find(e=>e.uid===t.id);return{id:t.id,name:t.name,logo:t.logo,permissions:n.permissions}});t(o)})});Promise.all([n,o,a]).then(n=>{let o;e.oid?e.overlay&&0!==Object.keys(e.overlay).length?(delete(o={...e._doc}).__v,delete o._id,t.json({channel:o,achievements:n[0],images:n[1],moderators:n[2]})):(e.overlay=T,e.save().then(e=>{delete(o={...e._doc}).__v,delete o._id,t.json({channel:o,achievements:n[0],images:n[1],moderators:n[2]})})):(e.oid=i(),e.overlay&&0!==Object.keys(e.overlay).length||(e.overlay=T),e.save().then(e=>{delete(o={...e._doc}).__v,delete o._id,t.json({channel:o,achievements:n[0],images:n[1],moderators:n[2]})}))})}else t.json({error:"User doesn't manage a channel"})})}),o.post("/mod",a,(e,t)=>{let n=e.body.mods,o=[];m.findOne({owner:e.user.name}).then(e=>{u.find({name:{$in:n}}).then(n=>{let i=e.moderators;n.forEach(e=>{i.push({uid:e.id,permissions:{channel:!0,chat:!0}}),o.push({name:e.name,logo:e.logo,permissions:{channel:!0,chat:!0}})}),e.moderators=i,e.save().then(e=>{t.json({moderators:o})})})})}),o.post("/mod/revoke",a,(e,t)=>{let n=e.body.mod;m.findOne({owner:e.user.name}).then(e=>{e&&u.findOne({name:n}).then(n=>{if(n){let o=e.moderators,i=o.findIndex(e=>e.uid===n.id);i>=0?(o.splice(i,1),e.moderators=o,e.save().then(e=>{t.json({removed:i})})):t.json({error:"Error removing mod"})}})})}),o.post("/update",a,(e,t)=>{m.findOne({twitchID:e.user.integration.twitch.etid}).then(e=>{})}),o.post("/mod/preferences",s,(e,t)=>{k(e,t,e.channel)}),o.post("/preferences",a,(e,t)=>{m.findOne({twitchID:e.user.integration.twitch.etid}).then(n=>{n?k(e,t,n):t.json({error:"Issue updating preferences"})})});let k=(e,t,n)=>{let o,i,a;o=new Promise((t,o)=>{e.body.defaultIcon&&h(e.body.defaultIcon)?b(e.body.defaultIcon,e.body.defaultIconName,n.owner,"default").then(e=>{t(e.url)}):e.body.defaultImage&&S.test(e.body.defaultImage)?t(e.body.defaultImage):t()}),i=new Promise((t,o)=>{e.body.hiddenIcon&&h(e.body.hiddenIcon)?b(e.body.hiddenIcon,e.body.hiddenIconName,n.owner,"hidden").then(e=>{t(e.url)}):e.body.hiddenImage&&S.test(e.body.hiddenImage)?t(e.body.hiddenImage):t()}),a=new Promise((t,o)=>{if(e.body.overlay){let{chat:o,chatMessage:i,sfx:a,enterEffect:s,exitEffect:r,duration:l,volume:d,delay:c}=e.body.overlay,h=n.overlay||{};o&&(h.chat=o),void 0!==i&&(h.chatMessage=i),a&&(h.sfx=process.env.WEB_DOMAIN+"sounds/achievement."+a+".mp3"),s&&(h.enterEffect=s),r&&(h.exitEffect=r),l&&(h.duration=l),d&&(h.volume=d),c&&(h.delay=c),t(h)}else t()}),Promise.all([o,i,a]).then(o=>{let i={default:n.icons.default,hidden:n.icons.hidden};o[0]&&(i.default=o[0]),o[1]&&(i.hidden=o[1]),o[2]&&(n.overlay=o[2],updateSettings=!0),n.icons=i,n.save().then(i=>{o[0]!==i.icons.default&&console.log("uh oh"),updateSettings&&x(e,{channel:i.owner,overlay:i.overlay}),f.find({channel:n.owner}).then(e=>{e?t.json({channel:i,images:{gallery:e}}):t.json({channel:i})})})})};o.post("/image",a,(e,t)=>{let n=e.body.image;_(n.cloudID).then(o=>{let i,a=new Promise((t,o)=>{""!==n.achievementID?p.findOne({_id:n.achievementID}).then(n=>{n?(n.icon="",n.save().then(()=>{p.find({channel:e.user.name}).then(e=>{t(e)})})):t()}):t()}),s=new Promise((t,o)=>{f.deleteOne({_id:n._id}).then(n=>{f.find({channel:e.user.name}).then(e=>{console.log("\nGetting all images after delete"),t(e?{gallery:e,default:""}:{gallery:[],default:""})})})});i="hidden"===n.type||"default"===n.type?new Promise((t,o)=>{m.findOne({twitchID:e.user.integration.twitch.etid}).then(e=>{let o={...e.icons};"default"===n.type?o.default=O:"hidden"===n.type&&(o.hidden=j),e.icons=o,e.save().then(e=>{t(e)})})}):Promise.resolve(),Promise.all([a,s,i]).then(e=>{let n={images:e[1]};e[0]&&(n.achievements=e[0]),e[2]&&(n.channel=e[2]),t.json(n)})})}),o.get("/user",a,(e,t)=>{let n,o,i,a={};e.user.favorites&&e.user.favorites.forEach(e=>{a[e]=!0});let s=e.user.favorites.map(e=>new l.Types.ObjectId(e)),r=e.user.channels.filter(t=>!e.user.favorites.includes(t.channelID)).map(e=>new l.Types.ObjectId(e.channelID)),d=new Promise((t,o)=>{m.find({_id:{$in:s}}).exec((o,i)=>{let a=i.map(t=>{let n=e.user.channels.find(e=>e.channelID===t.id),o=0;return new Promise((e,i)=>{p.countDocuments({channel:t.owner}).then(i=>{i>0&&(o=Math.round(n.achievements.length/i*100)),e({logo:t.logo,owner:t.owner,percentage:o,favorite:!0})})})});Promise.all(a).then(e=>{n=e,t()})})}),c=new Promise((t,n)=>{m.find({_id:{$in:r}}).limit(15).exec((n,a)=>{let s=a.map(t=>{let n=e.user.channels.find(e=>e.channelID===t.id),o=0;return new Promise((e,i)=>{p.countDocuments({channel:t.owner}).then(i=>{i>0&&(o=Math.round(n.achievements.length/i*100)),e({logo:t.logo,owner:t.owner,percentage:o,favorite:!1})})})});Promise.all(s).then(n=>{o=n,i=n.length<e.user.channels.length?n.length:-1,t()})})});Promise.all([d,c]).then(e=>{t.json({channels:n.concat(o),offset:i})})}),o.get("/member/retrieve",a,(e,t)=>{let n=parseInt(e.query.offset);C(e,t,n).then(e=>{console.log(e.members.length+n),console.log(e.channel.members.length),n=e.members.length+n<e.channel.members.length?e.members.length+n:-1,t.json({members:e.members,offset:n})})});let C=(e,t,n)=>new Promise((t,o)=>{m.findOne({owner:e.user.name}).then(e=>{if(e){let o=e.members;u.find({_id:{$in:o}}).sort({name:1}).skip(n).limit(15).exec((n,o)=>{let i=o.map(t=>{let n=t.channels.find(t=>t.channelID===e.id);return{name:t.name,logo:t.logo,achievementsEarned:n.achievements.map(e=>e.aid)}});t({members:i,channel:e})})}else o()})});o.get("/user/retrieve",a,(e,t)=>{let n=parseInt(e.query.offset),o=e.user.channels.filter(t=>!e.user.favorites.includes(t.channelID)).map(e=>new l.Types.ObjectId(e.channelID));m.find({_id:{$in:o}}).skip(n).limit(15).exec((o,i)=>{let a=i.map(t=>{let n=e.user.channels.find(e=>e.channelID===t.id),o=0;return new Promise((e,i)=>{p.countDocuments({channel:t.owner}).then(i=>{i>0&&(o=Math.round(n.achievements.length/i*100)),e({logo:t.logo,owner:t.owner,percentage:o,favorite:!1})})})});Promise.all(a).then(o=>{n=o.length+n<e.user.channels.length?o.length+n:-1,t.json({channels:o,offset:n})})})}),o.post("/signup",a,(e,t)=>{e.body.uid;let n=new v({uid:e.user._id,token:"not issued"}),o=d.randomBytes(16).toString("hex");n.token=o,n.created=Date.now(),n.save().then(n=>{let i=e.user.email;var a={type:"oauth2",user:process.env.GML,clientId:process.env.GMLCID,clientSecret:process.env.GMLCS,refreshToken:process.env.GMLRT},s=c.createTransport({service:"gmail",auth:a});const r={from:process.env.GML,to:i,subject:"Your Confirmation Code!",html:'<div style="background:#222938;padding-bottom:30px;"><h1 style="text-align:center;background:#2f4882;padding:15px;margin-top:0;"><img style="max-width:600px;" src="https://res.cloudinary.com/phirehero/image/upload/v1557947921/sa-logo.png" /></h1><h2 style="color:#FFFFFF; text-align: center;margin-top:30px;margin-bottom:25px;font-size:22px;">Thank you for your interest in Stream Achievements!</h2><p style="color:#FFFFFF;font-weight:bold;font-size:16px; text-align: center;">You are ready to start creating achievements that your community will be able to hunt for and earn!</p><p style="color:#FFFFFF;font-weight:bold;font-size:16px; text-align: center;">To get started, all you need to do is <a style="color: #ecdc19;" href="http://streamachievements.com/channel/verify?id='+o+'&utm_medium=Email">verify your account</a>, and you\'ll be all set!</p><p style="color:#FFFFFF;font-weight:bold;font-size:16px; text-align: center;">We are truly excited to see what you bring in terms of achievements, and can\'t wait to see how much your community engages and enjoys them!</p></div>'};s.sendMail(r,function(n,o){n?console.log(n):new w({user:e.user._id,logo:O,message:"Your channel is ready to begin! Go check your email for your confirmation code, and don't forget to check your spam folder!",date:Date.now(),type:"confirmation",status:"new"}).save().then(e=>{console.log(e)}),t.json({message:"email sent"})})})}),o.post("/queue",r,(e,t)=>{let n=e.body.uid;v.deleteOne({uid:n}).then(e=>{u.findById(n).then(e=>{e.email;c.createTransport({service:"gmail",auth:{user:process.env.GML,pass:process.env.GMLP}});process.env.GML})})}),o.post("/confirm",r,(e,t)=>{u.findOne({name:e.body.name}).then(e=>{let n=e._id;v.findOne({uid:n}).then(o=>{let i=d.randomBytes(16).toString("hex");o.token=i,o.created=Date.now(),o.save().then(o=>{let a=e.email;var s={type:"oauth2",user:process.env.GML,clientId:process.env.GMLCID,clientSecret:process.env.GMLCS,refreshToken:process.env.GMLRT},r=c.createTransport({service:"gmail",auth:s});const l={from:process.env.GML,to:a,subject:"Your Confirmation Code!",html:'<div style="background:#222938;padding-bottom:30px;"><h1 style="text-align:center;background:#2f4882;padding:15px;margin-top:0;"><img style="max-width:600px;" src="https://res.cloudinary.com/phirehero/image/upload/v1557947921/sa-logo.png" /></h1><h2 style="color:#FFFFFF; text-align: center;margin-top:30px;margin-bottom:25px;font-size:22px;">Thank you for your interest in Stream Achievements!</h2><p style="color:#FFFFFF;font-weight:bold;font-size:16px; text-align: center;">We reviewed your channel and feel you are a perfect fit to join in on this pilot, and test the new features we aim to provide for streamers!</p><p style="color:#FFFFFF;font-weight:bold;font-size:16px; text-align: center;">To get started, all you need to do is <a style="color: #ecdc19;" href="http://streamachievements.com/channel/verify?id='+i+'&utm_medium=Email">verify your account</a>, and you\'ll be all set!</p><p style="color:#FFFFFF;font-weight:bold;font-size:16px; text-align: center;">We are truly excited to see what you bring in terms of Achievements, and can\'t wait to see how much your community engages!</p></div>'};r.sendMail(l,function(e,o){e?console.log(e):new w({user:n,logo:O,message:"Your channel has been approved! Go check your email for your confirmation code! Don't forget to check your spam folder, too!",date:Date.now(),type:"confirmation",status:"new"}).save().then(e=>{console.log(e)}),t.json({message:"email sent"})})})})})}),o.post("/verify",a,(e,t)=>{let n=e.body.id;v.findOne({uid:e.user._id,token:n}).then(o=>{if(o)if(o.hasExpired())v.deleteOne({uid:e.user._id,token:n}).then(e=>{t.json({expired:!0})}),t.json({expired:!0});else{let o=e.user.broadcaster_type;new m({owner:e.user.name,twitchID:e.user.integration.twitch.etid,theme:"",logo:e.user.logo,members:[],moderators:[],icons:{default:O,hidden:j},oid:i(),overlay:T,nextUID:1,broadcaster_type:{twitch:o}}).save().then(o=>{new w({user:process.env.NOTICE_USER,logo:o.logo,message:`${o.owner} just created their channel!`,date:Date.now(),type:"confirmation",status:"new"}).save(),e.user.type="verified",e.user.save().then(o=>{v.deleteOne({uid:e.user._id,token:n}).then(e=>{t.json({verified:!0})})})})}else t.json({error:"Unauthorized"})})}),o.get("/overlay",(e,t)=>{let n=e.query.id;m.findOne({oid:n}).then(e=>{e&&t.json({overlay:e.overlay,icons:e.icons})})}),o.get("/testOverlay",a,(e,t)=>{D(e,{user:e.user.name,channel:e.user.name,title:"Test Achievement",icon:"https://res.cloudinary.com/phirehero/image/upload/v1558811694/default-icon.png",unlocked:!0}),t.json({})}),o.post("/reorder",a,(e,t)=>{let n=e.body.achievements;if(n){let o={};n.forEach(e=>{o[e.uid]=e.order}),p.find({channel:e.user.name}).then(e=>{e?(e.forEach(e=>{let t=o[e.uid];e.order&&e.order===t||(e.order=t,e.save())}),t.json({})):t.json({error:"Issue updating achievements. Try again later."})})}else t.json({error:"Unexpected use of the API"})}),o.post("/favorite",a,(e,t)=>{let n=e.body.channel,o=e.body.task;m.findOne({owner:n}).then(n=>{if(n){if("add"===o)e.user.favorites.push(n.id),e.user.save().then(e=>{t.json({favorited:!0,favorites:e.favorites})});else if("remove"===o&&e.user.favorites){var i=e.user.favorites.findIndex(e=>e===n.id);e.user.favorites.splice(i,1),e.user.save().then(e=>{t.json({favorited:!1,favorites:e.favorites})})}}else t.json({error:"Channel doesn't exist!"})})}),o.get("/mod",a,(e,t)=>{m.find({"moderators.uid":e.user._id}).then(e=>{let n=e.map(e=>({owner:e.owner,logo:e.logo}));t.json({channels:n})})}),o.get("/mod/retrieve",s,(e,t)=>{E(e,t,e.channel)});let E=(e,t,n)=>{let o=new Promise((e,t)=>{p.find({channel:n.owner}).then(t=>{if(t){let n=t.map(e=>e.listener);g.find({_id:{$in:n}}).then(n=>{let o=t.map(e=>{let t=n.find(t=>t.id===e.listener);if(t){let n={_id:e._id,uid:e.uid,channel:e.owner,title:e.title,description:e.description,icon:e.icon,earnable:e.earnable,limited:e.limited,secret:e.secret,listener:e.listener,code:t.code,order:e.order};return t.resubType&&(n.resubType=t.resubType),t.query&&(n.query=t.query),n}return e});o.sort((e,t)=>e.order>t.order?1:-1),e(o)})}else e(t)})});Promise.all([o]).then(e=>{let o;n.oid?n.overlay&&0!==Object.keys(n.overlay).length?(delete(o={...n._doc}).__v,delete o._id,t.json({channel:o,achievements:e[0]})):(n.overlay=T,n.save().then(n=>{delete(o={...n._doc}).__v,delete o._id,t.json({channel:o,achievements:e[0]})})):(n.oid=i(),n.overlay&&0!==Object.keys(n.overlay).length||(n.overlay=T),n.save().then(n=>{delete(o={...n._doc}).__v,delete o._id,t.json({channel:o,achievements:e[0]})}))})};e.exports=o},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("valid-data-url")},function(e,t){e.exports=require("cloudinary")},function(e,t){e.exports={chat:!0,chatMessage:"{user} just earned the {achievement} achievement! PogChamp",sfx:"https://streamachievements.com/sounds/achievement.001.mp3",enterEffect:"zoomIn",exitEffect:"zoomOut",duration:6,volume:100,delay:2}},function(e,t,n){const o=n(3).Router(),i=(n(5),n(15)),a=n(12),s=n(1),r=n(2),l=n(9),d=n(11),c=n(14),h=n(6),u=n(13),{isAuthorized:m,isModAuthorized:p}=n(7),{emitNewListener:g,emitUpdateListener:f,emitRemoveListener:v,emitAwardedAchievement:y,emitAwardedAchievementNonMember:w,emitOverlayAlert:b,emitNotificationsUpdate:_}=n(8),{build:I}=n(41),x=n(16).uploadImage,D="https://res.cloudinary.com/phirehero/image/upload/v1558811694/default-icon.png";n(0);let O=(e,t)=>{let n={_id:e._id,channel:e.owner,title:e.title,description:e.description,icon:e.icon,earnable:e.earnable,limited:e.limited,secret:e.secret,listener:e.listener,achType:t.achType,condition:t.condition};return t.query&&(n.query=t.query),n},j=(e,t,n,o,a,s)=>new Promise((r,c)=>{let h;(h=s?new Promise((e,t)=>{u.findOne({achievementID:n._id}).then(t=>{t?(t.achievementID="",t.save().then(()=>{s.achievementID=n._id,s.save().then(t=>{e()})})):(s.achievementID=n._id,s.save().then(t=>{e()}))})}):Promise.resolve()).then(()=>{l.findOneAndUpdate({_id:n._id},{$set:o},{new:!0}).then(o=>{if(Object.keys(a).length>0)if(a.achType&&"3"===a.achType&&o.listener)d.findOne({_id:o.listener}).then(n=>{n&&(v(e,{uid:n.uid,channel:t,achievement:n.achievement,achType:n.achType,query:n.query,bot:n.bot,condition:n.condition}),d.deleteOne({_id:o.listener}).then(e=>{o.listener=void 0,o.save().then(e=>{r({update:!0,achievement:e})})}))});else if(a.achType&&"3"!==a.achType&&!n.listener){let n={channel:t,uid:i(),...a,achievement:o.id,aid:o.uid};new d(n).save().then(t=>{g(e,{uid:t.uid,channel:t.channel,achievement:t.achievement,achType:t.achType,query:t.query,bot:t.bot,condition:t.condition}),o.listener=t.id,o.save().then(e=>{r({created:!0,achievement:e})})})}else d.findOneAndUpdate({_id:o.listener},{$set:a},{new:!0}).then(n=>{if(n){f(e,{uid:n.uid,channel:t,achievement:n.achievement,achType:n.achType,query:n.query,bot:n.bot,condition:n.condition});let i=O(o,n);r({update:!0,achievement:i})}else console.log("issue updating listener for achievement"),console.log("owner: "+t),console.log("achievement: "+j.title),r({update:!1})});else d.findOne({_id:o.listener}).then(e=>{let t=O(o,e);r({update:!0,achievement:t})})})})}),S=e=>new Promise((t,n)=>{u.find({channel:e,type:"achievement"}).then(e=>{if(e){let n={active:[],inactive:[]};e.map(e=>{e.achievementID&&""!==e.achievementID?n.active.push(e):n.inactive.push(e)}),t(n.active.concat(n.inactive))}else t([])})});o.post("/mod/update",p,(e,t)=>{T(e,t,e.channel,!0)}),o.post("/update",m,(e,t)=>{r.findOne({twitchID:e.user.integration.twitch.etid}).then(n=>{n?T(e,t,n,!1):t.json({update:!1,message:"The channel you tried to update the achievement for doesn't exist!"})})});let T=(e,t,n,o)=>{l.findOne({_id:e.body.id,channel:n.owner}).then(o=>{if(o){let i=e.body,{achType:a,query:s,bot:r,condition:l}=i,d={};a&&(d.achType=a,delete i.achType),s&&(d.query=s,delete i.query),r&&(d.bot=r,delete i.bot),l&&(d.condition=l,delete i.condition),i.icon&&i.iconName?x(i.icon,i.iconName,n.owner).then(a=>{i.icon=a.url,j(e,n.owner,o,i,d,a).then(e=>{t.json(e)})}):j(e,n.owner,o,i,d).then(e=>{t.json(e)})}else t.json({update:!1,message:"The achievement you tried to update doesn't exist!"})})};o.post("/mod/create",p,(e,t)=>{k(e,t,e.channel,!0)}),o.post("/create",m,(e,t)=>{r.findOne({twitchID:e.user.integration.twitch.etid}).then(n=>{n?k(e,t,n,!1):t.json({created:!1,message:"This channel you are creating for doesn't exist!"})})});let k=(e,t,n,o)=>{let a={};e.body.id?a._id=e.body.id:a.title=e.body.title,a.channel=n.owner,"4"!==e.body.achType||n.gold?l.findOne(a).then(o=>{o?t.json({created:!1,message:"An achievement with this name already exists!",achievement:o}):l.countDocuments({channel:n.owner}).then(o=>{let a={uid:n.nextUID,channel:n.owner,title:e.body.title,description:e.body.description,icon:e.body.icon,earnable:e.body.earnable,limited:e.body.limited,secret:e.body.secret,listener:e.body.listener,order:o},s={channel:n.owner,achType:e.body.achType,uid:i()};s.condition=e.body.condition,"4"===s.achType&&(s.bot=e.body.bot,s.query=e.body.query),d.findOne(s).then(o=>{o?l.findOne({listener:o._id}).then(e=>{t.json({created:!1,message:'The conditions you selected are already taken by the "'+e.title+'" achievement!'})}):e.body.icon?x(e.body.icon,e.body.iconName,n.owner).then(o=>{a.icon=o.url,new l(a).save().then(i=>{s.achievement=i.id,s.aid=i.uid,o.achievementID=i.id,o.save().then(o=>{n.nextUID=i.uid+1,n.save().then(n=>{"3"!==e.body.achType?new d(s).save().then(n=>{g(e,{uid:s.uid,channel:s.channel,achievement:s.achievement,achType:s.achType,query:s.query,bot:s.bot,condition:s.condition}),i.listener=n.id,i.save().then(e=>{t.json({created:!0,achievement:e})})}):t.json({created:!0,achievement:i})})})})}):new l(a).save().then(o=>{s.achievement=o.id,s.aid=o.uid,n.nextUID=o.uid+1,n.save().then(n=>{"3"!==e.body.achType?new d(s).save().then(n=>{g(e,{uid:s.uid,channel:s.channel,achievement:s.achievement,achType:s.achType,query:s.query,bot:s.bot,condition:s.condition}),o.listener=n.id,o.save().then(e=>{t.json({created:!0,achievement:e})})}):t.json({created:!0,achievement:o})})})})})}):t.json({created:!1,message:"This type of achievement is for Stream Achievements Gold! Sync your Patreon if your account is, or reach out on Discord!"})};o.post("/delete",m,(e,t)=>{r.findOne({twitchID:e.user.integration.twitch.etid}).then(n=>{if(n){let o={};o._id=e.body.achievementID,o.channel=n.owner,l.findOne(o).then(i=>{if(i){let a=i.listener;l.deleteOne(o).then(o=>{let s={_id:a,channel:i.channel};d.findOne(s).then(o=>{o?(v(e,{uid:o.uid,channel:n.owner,achievement:o.achievement,achType:o.achType,query:o.query,bot:o.bot,condition:o.condition}),d.deleteOne(s).then(n=>{u.findOneAndUpdate({achievementID:e.body.achievementID},{$set:{achievementID:""}}).then(e=>{t.json({deleted:!0})})})):u.findOneAndUpdate({achievementID:e.body.achievementID},{$set:{achievementID:""}}).then(e=>{t.json({deleted:!0})})})})}else t.json({deleted:!1,message:"The achievement you requested to delete doesn't exist!"})})}else t.json({delete:!1,message:"This channel you are deleting for doesn't exist!"})})}),o.get("/mod/retrieve",p,(e,t)=>{let n=e.query.aid;C(e,t,e.channel,n)}),o.get("/retrieve",m,(e,t)=>{let n=e.user.name,o=e.query.aid;o?r.findOne({twitchID:e.user.integration.twitch.etid}).then(n=>{n?C(e,t,n,o):t.json({error:"User isn't a verified channel owner"})}):n&&l.find({channel:n}).then(e=>{if(e){let n=e.map(e=>e.listener);d.find({_id:{$in:n}}).then(n=>{e.forEach(e=>{let t=n.find(t=>t._id=e.listener);return delete t._id,Object.assign(e,t)}),t.json(e)})}else t.json(e)})});let C=(e,t,n,o)=>{let i=new Promise((e,t)=>{l.findOne({uid:o,channel:n.owner}).then(t=>{if(t){t.listener;d.findOne({_id:t.listener,channel:t.channel}).then(n=>{if(n){let o=Object.assign({},n._doc),i=Object.assign({},t._doc);delete o._id;let a=Object.assign(i,o);e(a)}else e(t)})}else e(null)})}),a=S(n.owner),s=q(n.owner,n.gold);Promise.all([i,a,s]).then(o=>{t.json({achievement:o[0],images:o[1],defaultIcons:n.icons,isGoldChannel:e.channel&&e.channel.gold,customAllowed:o[2]})})};o.post("/mod/award",p,(e,t)=>{A(e,t,e.channel)}),o.post("/award",m,(e,t)=>{r.findOne({twitchID:e.user.integration.twitch.etid}).then(n=>{A(e,t,n)})});let E=(e,t)=>{let n,o=e.overlay;return n=o.chatMessage&&""!==o.chatMessage?I({chatMessage:o.chatMessage,member:t.member,achievement:t.achievement}):`${t.member} just earned the "${t.achievement}" achievement! PogChamp`,console.log(n),{channel:e.owner,message:n}},A=(e,t,n)=>{let o=e.body.members,i=e.body.aid;l.findOne({uid:i,channel:n.owner}).then(a=>{s.find({name:{$in:o}}).then(o=>{let r=o.map((t,o)=>{let s=t.channels,r=s.findIndex(e=>e.channelID===n.id);return s[r].achievements.push({aid:i,earned:Date.now()}),t.channels=s,t.save().then(t=>{if(n.overlay.chat){let o={channel:n.owner,member:t.name,achievement:a.title};y(e,E(n,o))}new h({user:t._id,logo:n.logo,message:`You have earned the "${a.title}" achievement!`,date:Date.now(),type:"achievement",channel:n.owner,status:"new"}).save().then(n=>{_(e,{notification:{id:n._id,logo:n.logo,message:n.message,date:n.date,type:n.type,channel:n.channel,status:n.status},user:t.name})});let o=a.alert||!0,i=!1;n.gold&&(i=!0),o&&b(e,{user:t.name,channel:n.owner,title:a.title,icon:a.icon,unlocked:i})})});Promise.all(r).then(e=>{s.find({_id:{$in:n.members}}).then(e=>{let o=e.map(e=>({name:e.name,logo:e.logo,achievements:e.channels.filter(e=>e.channelID===n.id)[0].achievements}));t.json({members:o})})})})})};o.get("/mod/icons",p,(e,t)=>{P(e,t,e.channel,!0)}),o.get("/icons",m,(e,t)=>{r.findOne({twitchID:e.user.integration.twitch.etid}).then(n=>{n?P(e,t,n,!1):t.json({error:!0})})});let P=(e,t,n,o)=>{console.log("foo"),S(n.owner).then(e=>{let i={images:e.map(e=>{let t={...e._doc};return delete t.__v,delete t._id,t}),defaultIcons:n.icons};o&&(i.isGoldChannel=n.gold),q(n.owner,n.gold).then(e=>{i.customAllowed=e,t.json(i)})})},q=(e,t)=>t?Promise.resolve(!0):new Promise((t,n)=>{console.log(e),d.find({channel:e,achType:"4"}).then(e=>{console.log(e),e&&e.length>0?t(!1):t(!0)})});o.get("/listeners",(e,t)=>{let n=e.query.channel;Array.isArray(n)||(n=n.split(",")),l.find({owner:{$in:n}}).then(e=>{e.map(e=>{if(e.earnable&&e.listener)return e.listener})}),d.find({channel:{$in:n}}).then(e=>{e.length>0?t.json(e):t.json([])})}),o.post("/award/chat",(e,t)=>{let{achievement:n,channel:o,target:i,user:a}=e.body,l=!1;n&&o&&i&&a&&r.findOne({owner:o}).then(r=>{if(r&&r.gold){if(a===o)l=!0;else{let e=r.moderators.map(e=>e.uid);s.find({_id:{$in:e}},"name").then(e=>{if(e){e.findIndex(e=>e.name===a)>=0&&(l=!0)}})}if(l){let a={title:n,channel:o},s={name:i.toLowerCase()};N(e,t,r,a,s)}}})});let $=(e,t,n,o)=>{if(t.overlay.chat){let i={channel:t.owner,member:n.name,achievement:o.title};y(e,E(t,i))}let i=o.alert||!0,a=!1;t.gold&&(a=!0),i&&b(e,{user:n.name,channel:t.owner,title:o.title,icon:o.icon,unlocked:a})},M=(e,t,n,o,i,a,s,r)=>{if(t&&"1000"!==t){let u=[];"2000"===t?u.push("1000"):"3000"===t&&(u.push("1000"),u.push("2000")),d.find({achType:"0",condition:{$in:u},channel:n.owner}).then(t=>{let d=[];if(t){new Promise((e,a)=>{if(r){let o=t.map(e=>e.aid);console.log(o),c.find({twitchID:i.userID,name:i.name,channelID:n._id,achievementID:{$in:o}}).then(t=>{console.log(t),t&&t.length>0&&t.forEach(e=>{let t=o.findIndex(t=>t===e.achievementID);t>=0&&o.splice(t,1)}),d=o,e()})}else t.forEach(e=>{if(o){o.findIndex(t=>t.aid===e.aid)<0&&d.push(e.aid)}else d.push(e.aid)}),e()}).then(()=>{d.length>0&&l.find({channel:n.owner,uid:{$in:d}}).then(t=>{t?r?t.forEach(t=>{new c({twitchID:i.userID,name:i.name,channelID:n._id,achievementID:t.uid,earned:a}).save().then(o=>{$(e,n,i,t)})}):(t.forEach(t=>{i.channels[s].achievements.push({aid:t.uid,earned:a}),new h({user:i._id,logo:n.logo,message:`You have earned the "${t.title}" achievement!`,date:a,type:"achievement",channel:n.owner,status:"new"}).save().then(o=>{_(e,{notification:{id:o._id,logo:o.logo,message:o.message,date:o.date,type:o.type,channel:o.channel,status:o.status},user:i.name}),$(e,n,i,t)})}),i.save()):console.log("achievements not found")})})}})}},N=(e,t,n,o,i,r,d=2)=>{let u=new Date;l.findOne(o).then(l=>{l&&l.earnable&&s.findOne(i).then(m=>{if(m){console.log("> User: "+m.name);let a=m.channels.findIndex(e=>e.channelID===n.id);if(a>=0){console.log("> "+m.name+" is a part of this channel");let c=m.channels[a].achievements,p=m.channels[a].sync;if(c.findIndex(e=>e.aid===l.uid)<0){console.log("> "+m.name+" doesn't have this achievement yet");try{m.channels[a].achievements.push({aid:l.uid,earned:u}),m.save().then(t=>{new h({user:m._id,logo:n.logo,message:`You have earned the "${l.title}" achievement!`,date:u,type:"achievement",channel:n.owner,status:"new"}).save().then(t=>{_(e,{notification:{id:t._id,logo:t.logo,message:t.message,date:t.date,type:t.type,channel:t.channel,status:t.status},user:m.name})}),M(e,r,n,c,t,u,a),p&&(console.log("syncing for "+t.name),F(e,l.id,t,n,r)),$(e,n,t,l)})}catch(a){if(d>0){N(e,t,n,o,i,r,d-1)}else console.log("sending notice"),console.log(process.env.NOTICE_USER),new h({user:process.env.NOTICE_USER,logo:D,message:`Issue awarding ${n.owner}'s '${l.title}' to ${m.name}`,date:u,type:"admin",status:"new"}).save(),s.findOne({name:n.owner}).then(e=>{new h({user:e._id,logo:D,message:`Issue awarding '${l.title}' to ${m.name}! We are looking into the issue, feel free to manually award the achievement!`,date:u,type:"admin",status:"new"}).save()})}}else M(e,r,n,c,m,u,a)}else if(console.log("couldn't find the channel"),m.preferences.autojoin)try{m.channels.push({channelID:n.id,achievements:[{aid:l.uid,earned:u}]}),m.save().then(t=>{n.members.push(t.id),n.save().then(o=>{new h({user:t._id,logo:n.logo,message:`You have earned the "${l.title}" achievement!`,date:u,type:"achievement",channel:n.owner,status:"new"}).save().then(o=>{_(e,{notification:{id:o._id,logo:o.logo,message:o.message,date:o.date,type:o.type,channel:o.channel,status:o.status},user:t.name});let i=t.channels.findIndex(e=>e.channelID===n.id);M(e,r,n,!1,t,u,i),$(e,n,t,l)})})})}catch(a){if(d>0){N(e,t,n,o,i,r,d-1)}else new h({user:process.env.NOTICE_USER,logo:D,message:`Issue awarding ${n.owner}'s '${l.title}' to ${m.name}`,date:u,type:"admin",status:"new"}).save(),s.findOne({name:n.owner}).then(e=>{new h({user:e._id,logo:D,message:`Issue awarding '${l.title}' to ${m.name}! We are looking into the issue, feel free to manually award the achievement!`,date:u,type:"admin",status:"new"}).save()})}else c.findOne({name:m.name,channelID:n._id,achievementID:l.uid}).then(t=>{t||(new c({twitchID:m.integration.twitch.etid,name:m.name,channelID:n._id,achievementID:l.uid,earned:u}).save(),new h({user:m._id,logo:n.logo,message:`You have earned the "${l.title}" achievement!`,date:u,type:"achievement",channel:n.owner,status:"new"}).save().then(t=>{_(e,{notification:{id:t._id,logo:t.logo,message:t.message,date:t.date,type:t.type,channel:t.channel,status:t.status},user:m.name})}),M(e,r,n,!1,m,u,!1,!0),$(e,n,m,l))})}else{let t,o,s={};i.name?t=`https://api.twitch.tv/helix/users/?login=${i.name}`:i["integration.twitch.etid"]&&(t=`https://api.twitch.tv/helix/users/?id=${i["integration.twitch.etid"]}`),t?(console.log(t),o=new Promise((e,n)=>{a.get(t,{headers:{"Client-ID":process.env.TCID}}).then(t=>{console.log(t.data),t.data&&t.data.data&&t.data.data[0]&&(s.userID=t.data.data[0].id,s.name=t.data.data[0].login),e()})})):o=Promise.resolve(),o.then(()=>{console.log(s),s.userID&&s.name&&c.findOne({twitchID:s.userID,channelID:n._id,achievementID:l.uid}).then(t=>{console.log("hello"),t?console.log(s.name+" already had this achievement"):(console.log("didn't find "+l.uid+" in the queue."),new c({twitchID:s.userID,name:s.name,channelID:n._id,achievementID:l.uid,earned:u}).save().then(t=>{if(t){if(M(e,r,n,!1,s,u,!1,!0),n.overlay.chat){let t={channel:n.owner,member:s.name,achievement:l.title};w(e,E(n,t))}let t=l.alert||!0,o=!1;n.gold&&(o=!0),t&&b(e,{user:s.name,channel:n.owner,title:l.title,icon:l.icon,unlocked:o})}}))}).catch(e=>{console.log(e)})})}})})};o.post("/listeners",(e,t)=>{console.log("achievements to process...");let n=e.body,o=(new Date,{});n.forEach(e=>{o[e.channel]=o[e.channel]||[],o[e.channel].push(e)}),Object.keys(o).forEach(n=>{r.findOne({owner:n}).then(i=>{if(i){console.log("Issuing achievements for "+i.owner+" channel:"),o[n].forEach(n=>{let{channel:o,achievementID:a,tier:s,userID:r}=n,l={};n.userID||n.user;if(r)console.log(">>> userID: "+r),l["integration.twitch.etid"]=r;else if(n.user){console.log(">>> userName: "+n.user);let e=n.user;0===e.indexOf("@")&&(e=e.substr(1)),l.name=e.toLowerCase()}else console.log("<<<< No user came from IRC >>>>");N(e,t,i,{_id:a},l,s)})}})}),t.json({})});let F=(e,t,n,o,i)=>{d.find({achType:{$in:["0","1"]},channel:o.owner}).then(a=>{if(a){let s=a.findIndex(e=>e.achievement===t);if(s>=0){let t=a.splice(s,1)[0],r=t.achType,l=t.condition,d=[];if("1"===r){if(console.log("> sub backfilling"),a.forEach(e=>{"0"===e.achType?parseInt(e.condition)<=parseInt(i)&&d.push(e):parseInt(e.condition)<=parseInt(l)&&d.push(e)}),d.length>0){console.log("> Potentially Backfilling "+d.length+" achievements");let t=n.channels,i=t.findIndex(e=>e.channelID===o.id),a=n.channels[i].achievements,s=!1;d.forEach(e=>{a.findIndex(t=>t.aid===e.aid)<0?(s=!0,t[i].achievements.push({aid:e.aid,earned:Date.now()})):console.log("> Achievement already earned: "+e.aid)}),s&&new h({user:n._id,logo:o.logo,message:"Your previous subs have been backfilled!",date:new Date,type:"achievement",channel:o.owner,status:"new"}).save().then(t=>{_(e,{notification:{id:t._id,logo:t.logo,message:t.message,date:t.date,type:t.type,channel:t.channel,status:t.status},user:n.name})}),t[i].sync=!1,n.channels=t,n.save().then(e=>{console.log(`> ${e.name} has been synced`)})}}else console.log("> The achievement wasn't a resub")}}})};e.exports=o},function(e,t){let n={"{user}":"member","{achievement}":"achievement"};e.exports={build:e=>{console.log(e);let t=Object.keys(n),o=e.chatMessage;return o=(e=>e.replace(/[.*+?^$()|[\]\\]/g,"\\$&"))(o),t.forEach(t=>{o=o.replace(new RegExp(t,"gi"),e[n[t]])}),o}}},function(e,t,n){const o=n(3).Router(),i=n(1),a=n(11);n(10),n(0);o.get("/channels",(e,t)=>{let n=parseInt(e.query.offset)||0,o=parseInt(e.query.limit)||50,a=parseInt(e.query.total)||void 0;a?r(n,o,a).then(e=>{e.err?(t.status(500),t.json({channels:[],err:e.err})):t.json(e)}):a=i.estimatedDocumentCount().exec().then(e=>{r(n,o,a=e).then(e=>{e.err?(t.status(500),t.json({channels:[],err:e.err})):t.json(e)})})}),o.get("/listeners",(e,t)=>{let n=parseInt(e.query.offset)||0,o=parseInt(e.query.limit)||50,i=parseInt(e.query.total)||void 0;i?s(n,o,i).then(e=>{e.err?(t.status(500),t.json({listeners:[],error:e.err})):t.json(e)}):i=a.estimatedDocumentCount().exec().then(e=>{s(n,o,i=e).then(e=>{e.err?(t.status(500),t.json({listeners:[],error:e.err})):t.json(e)})})});let s=(e,t,n)=>new Promise((o,i)=>{a.find().sort({_id:-1}).skip(e).limit(t).exec((i,a)=>{if(i)o({err:"Issue retrieving from Listener sets"});else{let i=a.map(e=>({channel:e.channel,achievement:e.achievement,achType:e.achType,resubType:e.resubType,query:e.query,bot:e.bot,condition:e.condition})),s={listeners:i,total:n};i.length===t&&(s.offset=e+i.length),o(s)}})}),r=(e,t,n)=>new Promise((o,a)=>{i.find({$or:[{type:"verified"},{type:"admin"}]}).sort({_id:-1}).skip(e).limit(t).exec((i,a)=>{if(i)o({err:"Issue retrieving from User sets"});else{let i=a.map(e=>{let t={name:e.name,full_access:!1},n=e.integration.patreon;return n&&(n.forever||n.is_gold)&&(t["full-access"]=!0),t}),s={channels:i,total:n};i.length===t&&(s.offset=e+i.length),o(s)}})});e.exports=o},function(e,t,n){const o=n(3).Router(),i=n(12),a=n(1),s=n(11),r=(n(10),n(14)),l=n(2),d=n(6),c=n(9),{isAdminAuthorized:h}=(n(0),n(7)),{emitOverlayAlert:u}=n(8);o.post("/dedupMembers",h,(e,t)=>{l.findOne({owner:"phirehero"}).then(e=>{console.log(e.members);let t=e.members;console.log(t);let n=[];a.find({_id:{$in:t}}).sort({name:1}).exec((e,o)=>{o.forEach(e=>{let o=t.splice(t.indexOf(e.id),1);n.push(o[0])}),console.log(n),console.log(n.length)})})}),o.post("/dedup",h,(e,t)=>{a.find({}).then(e=>{e.forEach(e=>{console.log("dedup for "+e.name+"...");let t=[];e.channels.forEach(e=>{console.log(">>> checking channel: "+e.channelID);let n=e.achievements;console.log(n);let o=n.filter((e,t,n)=>n.findIndex(t=>t.aid===e.aid)===t);if(o.length!==n.length&&console.log(">>>>>> duplicates found: "+(n.length-o.length)),o.length>0){console.log("\n"),console.log(e),console.log("--------------------------------------------");let n={...e._doc,achievements:o};console.log(n),t.push(n)}else t.push(e)}),e.channels=t,e.save()})})}),o.post("/fixit",h,(e,t)=>{c.find({}).then(e=>{e&&e.forEach(e=>{e.listener&&s.findById(e.listener).then(t=>{t&&(console.log("updating: "+e.channel+": "+e.title),t.aid=e.uid,t.achievement=e.id,t.save())})})})}),o.post("/flush",h,(e,t)=>{r.find({}).then(e=>{e.length>0?e.forEach(e=>{try{console.log("finding "+e.channelID+" channel"),l.findOne({owner:e.channelID}).then(t=>{t?e&&e.achievementID&&c.findOne({uid:parseInt(e.achievementID),channel:t.owner}).then(n=>{n?a.findOne({"integration.twitch.etid":e.twitchID}).then(o=>{if(o){console.log("we found "+o.name);let i=o.channels,a=i.findIndex(e=>e.channelID===t.id);if(a>=0){i[a].achievements.filter(e=>{e.aid,n.uid})?(console.log(o.name+"already has "+n.title+". Delete it"),r.deleteOne({_id:e.id}).then(e=>{console.log("deleted count: "+e.deletedCount)})):(console.log("achievement will be awarded to "+o.name),o.channels[a].achievements.push({aid:n.uid,earned:e.earned||Date.now()}),console.log("deleting entry"),console.log(e),r.deleteOne({_id:e.id}).then(e=>{console.log("deleted count: "+e.deletedCount)}),o.save())}else console.log(o.name+"hasn't joined "+t.owner+"'s channel yet")}else console.log("no user")}):console.log("no achievement")}):console.log("no channel")})}catch(t){console.log(t),console.log("cast issue for "+e.channelID)}}):console.log("nothing in queue")})}),o.post("/fixpreferences",h,(e,t)=>{l.find({}).then(e=>{e&&e.forEach(e=>{e.overlay={chat:!0,chatMessage:"{user} just earned the {achievement} achievement! PogChamp",sfx:"https://streamachievements.com/sounds/achievement.001.mp3",enterEffect:"zoomIn",exitEffect:"zoomOut",duration:6,volume:100,delay:2},e.save().then(e=>{console.log("updated "+e.owner+"'s channel overlay")})})})}),o.post("/overlay",h,(e,t)=>{u(e,{user:e.user.name,channel:e.user.name,title:"I can show you the world",icon:"https://res.cloudinary.com/phirehero/image/upload/v1562881653/u9astg4olsdtfm2rjhxu.png",unlocked:!0})}),o.post("/sync",h,(e,t)=>{a.find({}).then(e=>{e&&e.forEach(e=>{let t=[],n=e.channels;n&&(n.forEach(e=>{let n={...e._doc,sync:!0};t.push(n)}),e.channels=t,e.save())})})}),o.post("/alertSync",h,(e,t)=>{c.find({}).then(e=>{e&&e.forEach(e=>{e.alert=!0,e.save()})})}),o.post("/notice",h,(e,t)=>{new d({user:"5cfc5f04a33c32ad539abe0c",logo:"https://static-cdn.jtvnw.net/jtv_user_pictures/thorlar-profile_image-4bd4d7b82e71afc3-300x300.jpeg",message:'You earned the "Noisy Viking" Achievement!',date:Date.now()}).save().then(e=>{console.log(e),t.json(e)})}),o.post("/tier2",h,(e,t)=>{i({method:"post",url:"/api/achievement/listeners",data:[{channel:"phirehero",achievementID:"5d7661fa447cce56ece85ef8",tier:"2000",userID:"70967393"}]})}),e.exports=o}]);